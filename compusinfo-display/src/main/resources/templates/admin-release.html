<!DOCTYPE html>
<!--[if IE 8]>
<html class="lt-ie9" lang="en-US" xmlns:th="http://www.thymeleaf.org"> <![endif]-->
<!--[if gt IE 8]><!-->
<html lang="en" xmlns:th="http://www.thymeleaf.org"> <!--<![endif]-->
    <head>
        <meta charset="UTF-8">
        <title>发布文章</title>
        <script src="../static/admin/js/myJS/config.js" type="text/javascript"></script>
        <script src="../static/admin/js/myJS/common.js" type="text/javascript"></script>
        <script src="../static/admin/js/myJS/index.js" type="text/javascript"></script>
        <script type="text/javascript" src="../static/admin/js/jquery-1.5.2.min.js"></script>
        <script type="text/javascript" src="../static/admin/js/jquery-1.5.2.min.js"></script>
    </head>
    <body>
    <div th:include="com/adminhead.html"></div>
        <!-- content YDC begin -->
        <section>
            <div class="ydc-content-slide ydc-body">
                <div class="ydc-flex">
                    <!-- left begin -->
                    <div th:include="/com/admin-com.html"></div>
                    <!-- left end -->
                    <!-- right begin -->
                    <div class="ydc-column ydc-column-8">
                        <div class="ydc-release-content">
                            <div class="ydc-tabPanel ydc-tabPanel-release">
                                <div class="ydc-release-tab-head">
                                    <ul>
                                        <li class="hit">发布文章</li>
                                    </ul>
                                    <div class="ydc-release-amount">
                                        <span>
                                            <a href="standard.html" target="_blank">发文规范</a>
                                        </span>
                                    </div>
                                </div>
                                <div class="ydc-panes">
                                    <div class="ydc-pane" style="display:block;">
                                        <div class="ydc-release-form-group ">
                                            <div class="ydc-warning-default">
                                                <p>标题字数需在11字到30字之间。</p>
                                            </div>
                                            <div class="ydc-release-form-group-input">
                                                <input type="text" class="ydc-form-control" id="art-title" title="" placeholder="请输入标题，为了更好的展示效果，建议标题字数在30个汉字以内" onkeyUp="textLimitCheck(this, 30);">
                                                <div class="ydc-form-group-jl">
                                                    <span id="messageCount">0</span>
                                                    /30
                                                </div>
                                            </div>
                                        </div>
<!--                                        <div class="ydc-release-form-text">-->
<!--                                            <textarea name="area2" style="width: 100%;">请输入内容-->
<!--										</textarea>-->
                                        <div id="editor">
                                            <p>正文...</p>
                                        </div>
                                        <div class="ydc-form-city">
                                            <form action="">
                                                <div class="aui-card-form-item">
                                                    <label class="aui-card-form-label">分类:</label>
                                                    <div class="aui-card-form-input">
                                                        <select id="province">
                                                            <option th:value="5">互联网</option>
                                                            <option th:value="6">污物</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="aui-card-form-item preview  aui-news">
                                                    <label class="aui-card-form-label">封面:</label>
                                                    <div class="aui-file-up-img" id="preview_0">
                                                        <img class="" id="imghead_0" border="0" src="../static/admin/images/icon/noimg.gif">
                                                    </div>
                                                    <div class="aui-file-up-btn clearfix ">
                                                        <div class="idPicFile aui-btn aui-file-new">
                                                            <input type="file" name="file" id="1" class="file_photo aui-file-new-up" style="margin:0;">
                                                            <a>上传图片</a>
                                                        </div>
                                                        <div class="aui-remarks">
                                                            <p>图片尺寸建议：800*400 图片大小不超过1MB</p>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="ydc-btn">
                                                    <button class="btn" id="relaseArt">发布</button>
                                                    <button class="btn btn-default" id="submitArt">保存草稿</button>
                                                </div>
                                            </form>


                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- right end -->
                </div>
            </div>
        </section>
        <!-- content YDC end -->
        <script type="text/javascript" src="../static/admin/js/nicEdit.js"></script>
        <script type="text/javascript" src="../static/admin/js/upImg.js"></script>
        <script>
             $("#admin-release").addClass("active");
        </script>
        <script type="text/javascript">
	    jQuery(function(){
	        upload_start();
	    });
        </script>
<!--        <script type="text/javascript">-->
<!--            -->
<!--	    bkLib.onDomLoaded(function() { nicEditors.allTextAreas() });//编辑器-->
<!--	-->
<!--        </script>-->

        <script type="text/javascript">
	    function textLimitCheck(thisArea, maxLength){
	        if (thisArea.value.length > maxLength){
	            alert(maxLength + ' 个字限制. \r超出的将自动清除.');
	            thisArea.value = thisArea.value.substring(0, 30);
	            thisArea.focus();    }
	        messageCount.innerText = thisArea.value.length;
	        messageCount1.innerText = thisArea.value.length;
	        messageCount2.innerText = thisArea.value.length;
	    }//标题输入框字数限制
        </script>

<!--        以下是编辑器的-->
        <script src="../static/admin/edit.js/jquery-1.8.2.min.js"></script>
        <script src="../static/admin/edit.js/wangEditor.min.js"></script>
        <script src="https://unpkg.com/qiniu-js@2.2.2/dist/qiniu.min.js"></script>
        <script src="../static/admin/edit.js/ui.js"></script>
        <script src="../static/admin/edit.js/qiniu.js"></script>
        <script src="../static/admin/edit.js/highlight.js"></script>
        <script>
            var E = window.wangEditor;
            var editor = new E('#editor');
            // editor.customConfig.pasteIgnoreImg = true          //复制过来的内容不粘贴图片
            editor.customConfig.pasteFilterStyle = false      //手动关闭掉粘贴样式的过滤
            editor.customConfig.uploadImgShowBase64 = true   // 使用 base64 保存图片
            editor.customConfig.showLinkImg = false  // 隐藏“网络图片”tab
            editor.customConfig.uploadFileName = 'picture'      //给上传的本地图片文件命名的统一名称
            editor.customConfig.uploadImgServer = '/admin/picture/upload'; //官方文档上写的是服务器地址，也就是上传图片的方法名
            // editor.customConfig.qiniu = true;
            editor.customConfig.debug = true;

            //wangEditor 从v3版本开始不支持 textarea ，但是可以通过onchange来实现 textarea 中提交富文本内容。
            // var $text1 = $('#text1')
            // editor.customConfig.onchange = function (html) {
            //     // 监控变化，同步更新到 textarea
            //     $text1.val(html)
            // };
            editor.create();
            // $text1.val(editor.txt.html()) //同步textarea和editor的内容
            $("#relaseArt").click(function(){
                //获取编辑器的内容，带样式
                //一般使用这个获取数据，通过ajax发送给服务端　，然后服务端以Ｓtring接收，保存到数据库．
                var _connent=editor.txt.html();
                var  art_title=$("#art-title").val();
                var type = $("#province option:selected");
                var type_id=type.val();//获取选中项的值
                let data = {
                    title:art_title,
                    content:_connent,
                    typeId: type_id,
                    userId: 1,
                };
                publicArticle(data);
            })

            // 上传图片
            uploadInit();
            // 初始化七牛上传的方法
            function uploadInit() {
                // 获取相关 DOM 节点的 ID
                var btnId = editor.imgMenuId;
                var containerId = editor.toolbarElemId;
                var textElemId = editor.textElemId;
                /**
                 * html此处后台配置
                 * <input type="hidden" id="domain" value="http://{:config('qiniu')['domain']}/">
                 <input type="hidden" id="uptoken_url" value="{:url('../static/admin/Adv/getUptoken')}">
                 <input type="hidden" id="uptoken_val">*
                 * */
                var uptoken = '';  //这个是七牛的uptoken 后台获取
                // 创建上传对象
                var uploader = Qiniu.uploader({
                    runtimes: 'html5,flash,html4',    //上传模式,依次退化
                    browse_button: btnId,       //上传选择的点选按钮，**必需**
                    uptoken: uptoken,
                    //Ajax请求upToken的Url，**强烈建议设置**（服务端提供）
                    // uptoken : '<Your upload token>',
                    //若未指定uptoken_url,则必须指定 uptoken ,uptoken由其他程序生成
                    // unique_names: true,
                    // 默认 false，key为文件名。若开启该选项，SDK会为每个文件自动生成key（文件名）
                    // save_key: true,
                    // 默认 false。若在服务端生成uptoken的上传策略中指定了 `sava_key`，则开启，SDK在前端将不对key进行任何处理
                    domain: $('#domain').val(),
                    //bucket 域名，下载资源时用到，**必需**
                    container: containerId,           //上传区域DOM ID，默认是browser_button的父元素，
                    max_file_size: '100mb',           //最大文件体积限制
                    flash_swf_url: '../js/plupload/Moxie.swf',  //引入flash,相对路径
                    filters: {
                        mime_types: [
                            //只允许上传图片文件 （注意，extensions中，逗号后面不要加空格）
                            { title: "图片文件", extensions: "jpg,gif,png,bmp" }
                        ]
                    },
                    max_retries: 3,                   //上传失败最大重试次数
                    dragdrop: true,                   //开启可拖曳上传
                    drop_element: textElemId,        //拖曳上传区域元素的ID，拖曳文件或文件夹后可触发上传
                    chunk_size: '4mb',                //分块上传时，每片的体积
                    auto_start: true,                 //选择文件后自动上传，若关闭需要自己绑定事件触发上传
                    init: {
                        'FilesAdded': function(up, files) {
                            plupload.each(files, function(file) {
                                // 文件添加进队列后,处理相关的事情
                                console.log('on FilesAdded');
                            });
                        },
                        'BeforeUpload': function(up, file) {
                            // 每个文件上传前,处理相关的事情
                            console.log('on BeforeUpload');
                        },
                        'UploadProgress': function(up, file) {
                            // 显示进度
                            console.log('进度 ' + file.percent)
                        },
                        'FileUploaded': function(up, file, info) {
                            // 每个文件上传成功后,处理相关的事情
                            // 其中 info 是文件上传成功后，服务端返回的json，形式如
                            // {
                            //    "hash": "Fh8xVqod2MQ1mocfI4S4KpRL6D98",
                            //    "key": "gogopher.jpg"
                            //  }
                            console.log(info);
                            // 参考http://developer.qiniu.com/docs/v6/api/overview/up/response/simple-response.html

                            var domain = up.getOption('domain');
                            // console.log(domain);
                            var res = $.parseJSON(info.response);
                            console.log(res);
                            var sourceLink = domain + res.key; //获取上传成功后的文件的Url
                            console.log(sourceLink);

                            // 插入图片到editor
                            editor.cmd.do('insertHtml', '<img src="' + sourceLink + '" style="max-width:100%;"/>')
                        },
                        'Error': function(up, err, errTip) {
                            //上传出错时,处理相关的事情
                            console.log('on Error');
                        },
                        'UploadComplete': function() {
                            //队列文件处理完毕后,处理相关的事情
                            console.log('on UploadComplete');
                        }
                        // Key 函数如果有需要自行配置，无特殊需要请注释
                        //,
                        // 'Key': function(up, file) {
                        //     // 若想在前端对每个文件的key进行个性化处理，可以配置该函数
                        //     // 该配置必须要在 unique_names: false , save_key: false 时才生效
                        //     var key = "";
                        //     // do something with key here
                        //     return key
                        // }
                    }
                });
            }
        </script>






    </body>
</html>
